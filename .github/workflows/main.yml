name: Deploy Sapine Nodes API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  TERM: xterm-256color

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Send Telegram start
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 7269251740
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="ðŸš€ *Deployment Started*
          Repo: ${{ github.repository }}
          Run: #${{ github.run_id }}" \
          -d parse_mode=Markdown

    - name: Update packages
      run: |
        sudo apt-get update
        sudo apt-get install -y curl git python3-venv python3-pip

    - name: Setup Cloudflare repo
      run: |
        sudo mkdir -p --mode=0755 /usr/share/keyrings
        curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg | \
          sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main' | \
          sudo tee /etc/apt/sources.list.d/cloudflared.list

    - name: Install cloudflared
      run: sudo apt-get update && sudo apt-get install -y cloudflared

    - name: Install cloudflared service
      run: sudo cloudflared service install eyJhIjoiY2U5MWFiYmQyYWU3YjhlZjQxMmU0YWQxODJmYzUxYzciLCJ0IjoiNzI2NWFlZjQtM2QyNS00MDE0LThjMjMtMzM3MGFiZTExNGJmIiwicyI6Ik9UVXhOR05qTmpZdE5HRTNZeTAwT0dVNUxXSTBZbUV0WmpkbU1XRTRZV0ptTVdJeCJ9

    - name: Clone sapine-nodes-api
      run: |
        git clone https://github.com/Arpitraj02/sapine-nodes-api.git
        cd sapine-nodes-api

    - name: Run install.sh
      run: |
        cd sapine-nodes-api
        chmod +x install.sh
        ./install.sh

    - name: Start Python app
      run: |
        cd sapine-nodes-api
        source venv/bin/activate
        nohup python -m app.main > app.log 2>&1 &
        echo "App PID: $!" | tee -a app.log
        sleep 10

    - name: Send success notification
      if: success()
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 7269251740
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="âœ… *App Deployed*
          Cloudflared: âœ… Installed
          App: âœ… Running 
          Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -d parse_mode=Markdown

    - name: Install sshx (OFFICIAL method)
      run: |
        # âœ… CORRECT: Use official get script as you showed
        curl -sSf https://sshx.io/get | sh -s -- install
        sshx --version

    - name: Create SSHX session
      id: sshx
      run: |
        # âœ… Run sshx directly - prints URL automatically
        sshx

    - name: Send SSHX URL (fallback)
      if: always()
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 7269251740
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="ðŸ”— *SSH Ready*
          *Check Actions logs above for SSHX URL!*
          User: root
          Commands:
          â€¢ cd sapine-nodes-api && tail -f app.log
          â€¢ systemctl status cloudflared
          Run: #${{ github.run_id }}" \
          -d parse_mode=Markdown

    - name: Keep alive 6h
      run: |
        cd sapine-nodes-api
        echo "âœ… Session active 6h - SSHX URL printed above"
        tail -f app.log /dev/null
