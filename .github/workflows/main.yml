name: Deploy Sapine Nodes API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Send Telegram start notification
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 8362379114
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="üöÄ *Deployment Started*  
          Repo: ${{ github.repository }}
          Run: #${{ github.run_id }}
          Status: Starting..." \
          -d parse_mode=Markdown

    - name: Update and install basics
      run: |
        sudo apt-get update
        sudo apt-get install -y curl git python3-venv python3-pip

    - name: Add Cloudflare GPG key
      run: |
        sudo mkdir -p --mode=0755 /usr/share/keyrings
        curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg | sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main' | sudo tee /etc/apt/sources.list.d/cloudflared.list

    - name: Install cloudflared
      run: sudo apt-get update && sudo apt-get install -y cloudflared

    - name: Install cloudflared service
      run: sudo cloudflared service install eyJhIjoiY2U5MWFiYmQyYWU3YjhlZjQxMmU0YWQxODJmYzUxYzciLCJ0IjoiNzI2NWFlZjQtM2QyNS00MDE0LThjMjMtMzM3MGFiZTExNGJmIiwicyI6Ik9UVXhOR05qTmpZdE5HRTNZeTAwT0dVNUxXSTBZbUV0WmpkbU1XRTRZV0ptTVdJeCJ9

    - name: Clone sapine-nodes-api
      run: |
        git clone https://github.com/Arpitraj02/sapine-nodes-api.git
        cd sapine-nodes-api

    - name: Run install.sh
      run: |
        cd sapine-nodes-api
        chmod +x install.sh
        ./install.sh

    - name: Activate venv and start app
      run: |
        cd sapine-nodes-api
        source venv/bin/activate
        nohup python -m app.main > app.log 2>&1 &
        APP_PID=$!
        echo "App PID: $APP_PID" >> app.log
        sleep 10
        echo "App is running on PID $APP_PID"

    - name: Send Telegram success notification
      if: success()
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 8362379114
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="‚úÖ *App Deployed Successfully*
Cloudflared: Installed ‚úÖ
Python App: Running 
Run ID: #${{ github.run_id }}
Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -d parse_mode=Markdown

    - name: Install sshx
      run: |
        curl -sSfL https://sshx.io/install.sh | bash
        sudo mv sshx /usr/local/bin/

    - name: Start sshx session
      id: sshx
      run: |
        export TERM=xterm-256color
        sshx_output=$(timeout 30 sshx -R0:localhost:22 2>&1 || true)
        sshx_url=$(echo "$sshx_output" | grep -o 'https://sshx\.io/[a-zA-Z0-9_-]*' | head -1)
        if [ -z "$sshx_url" ]; then
          sshx_url="Failed to create SSHX session"
        fi
        echo "SSHX_URL=$sshx_url" >> $GITHUB_ENV
        echo "sshx-url=$sshx_url" >> $GITHUB_OUTPUT

    - name: Send Telegram final SSHX URL
      if: always()
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 8362379114
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="üîó *SSH Access Ready*
üì± URL: ${{ steps.sshx.outputs.sshx-url || env.SSHX_URL }}
‚è∞ Expires: ~24 hours
üë§ User: root (passwordless sudo)
üíª Commands:
‚Ä¢ cd sapine-nodes-api && tail -f app.log
‚Ä¢ systemctl status cloudflared
‚Ä¢ ps aux | grep python
Run: #${{ github.run_id }}
Status: ${{ job.status }}" \
          -d parse_mode=Markdown

    - name: Keep running for 6 hours
      run: |
        cd sapine-nodes-api
        echo "Keeping session alive for 6 hours... Press Ctrl+C in SSHX to stop early"
        tail -f app.log /dev/null
