name: Deploy Sapine Nodes API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  TERM: xterm-256color  # Fixes TERM error globally

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Send Telegram start
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 8362379114
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="ðŸš€ *Deployment Started* 
          Repo: ${{ github.repository }}
          Run: #${{ github.run_id }}" \
          -d parse_mode=Markdown

    - name: Update packages
      run: |
        sudo apt-get update
        sudo apt-get install -y curl git python3-venv python3-pip

    - name: Setup Cloudflare repo
      run: |
        sudo mkdir -p --mode=0755 /usr/share/keyrings
        curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg | \
          sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null
        echo 'deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main' | \
          sudo tee /etc/apt/sources.list.d/cloudflared.list

    - name: Install cloudflared
      run: sudo apt-get update && sudo apt-get install -y cloudflared

    - name: Install cloudflared service
      run: sudo cloudflared service install eyJhIjoiY2U5MWFiYmQyYWU3YjhlZjQxMmU0YWQxODJmYzUxYzciLCJ0IjoiNzI2NWFlZjQtM2QyNS00MDE0LThjMjMtMzM3MGFiZTExNGJmIiwicyI6Ik9UVXhOR05qTmpZdE5HRTNZeTAwT0dVNUxXSTBZbUV0WmpkbU1XRTRZV0ptTVdJeCJ9

    - name: Clone sapine-nodes-api
      run: |
        git clone https://github.com/Arpitraj02/sapine-nodes-api.git
        cd sapine-nodes-api || exit 1

    - name: Run install.sh
      run: |
        cd sapine-nodes-api
        ls -la install.sh
        chmod +x install.sh
        ./install.sh

    - name: Start Python app
      run: |
        cd sapine-nodes-api
        source venv/bin/activate || echo "Venv not found, creating..."
        nohup python -m app.main > app.log 2>&1 &
        echo "App PID: $!" | tee -a app.log
        sleep 5
        ps aux | grep "[p]ython" || echo "App may not be running"

    - name: Send success notification
      if: success()
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 8362379114
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="âœ… *App Deployed*
           Cloudflared: âœ… Installed
           App: âœ… Running
           Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -d parse_mode=Markdown

    - name: Install sshx
      run: |
        curl -sSfL https://sshx.io/install.sh | bash
        sudo mv sshx /usr/local/bin/sshx

    - name: Create SSHX session
      id: sshx
      run: |
        sshx --version
        sshx_output=$(timeout 30 sshx -R0:localhost:22 2>&1 || true)
        sshx_url=$(echo "$sshx_output" | grep -o 'https://sshx.io/[a-zA-Z0-9_-]*' | head -1)
        echo "SSHX_URL=${sshx_url:-FAILED}" >> $GITHUB_ENV
        echo "sshx-url=${sshx_url:-FAILED}" >> $GITHUB_OUTPUT

    - name: Send SSHX URL
      if: always()
      env:
        TELEGRAM_TOKEN: 8362379114:AAFg_bOXNSu5uiLagudbPGS4Hshjg53NAmM
        TELEGRAM_CHAT_ID: 8362379114
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="ðŸ”— *SSH Ready*
          URL: ${{ steps.sshx.outputs.sshx-url }}
           User: root
          *Commands:*
         cd sapine-nodes-api && tail -f app.log
          systemctl status cloudflared
          ps aux | grep python" \
          -d parse_mode=Markdown

    - name: Keep alive 6h
      run: |
        cd sapine-nodes-api
        echo "âœ… Session active for 6 hours. Use SSHX URL above."
        tail -f app.log /dev/null
